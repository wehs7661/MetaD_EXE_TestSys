A quick tutorial about the basics of PLUMED
============================
## 1. Post-simulation data analysis
Using `plumed driver`, we can perform post-simulation data analysis on an MD simulation, no matter if PLUMED was used to run the simulation. Specifically, in folder `Analysis`, there are the following files:
- `complex_decouple.xtc`: A trajectory file of a vanilla MD simulation performed by GROMACS, in which the system of interest is a host-guest binding complex with all the interactions decoupled. 
- `complex.pdb`: The PDB file converted from the input structure (`.gro`) of the vanilla MD simulation, which provides the information of masses and charges to `plumed driver`, which is a tool that allows one to use PLUMED to post-process an existing trajectory.
- `plumed_dist.dat`: A PLUMED parameter file which defines the quantities to analyze in the trajectory. Specifically, the content of `plumed_dist.dat` file is as follows:
    ```
    com1: COM ATOMS=1-40                        # COM of the smaller ring
    com2: COM ATOMS=57-112,116-121,123-128      # COM of the bigger ring

    com_r1: COM ATOMS=88-93                     # endpoint of the bigger radius of the bigger ring
    com_r2: COM ATOMS=57-62                     # endpoint of the smaller radius of the bigger ring
    com_r3: COM ATOMS=5-11,1                    # endpoint of the smaller ring

    d1: DISTANCE ATOMS=com1,com2                # distance between centers of mass
    d2: DISTANCE ATOMS=com1,com_r1              # bigger radius of the bigger ring
    d3: DISTANCE ATOMS=com1,com_r2              # smaller radius of the bigger ring
    d4: DISTANCE ATOMS=com2,com_r3              # radius of the smaller ring

    PRINT ARG=d1,d2,d3,d4 STRIDE=10 FILE=dist.dat
    ```
    - The keyword `COM` calculates the center of mass for a group of atoms specified by `ATOMS`. The index of atom selection in PLUMED starts from 1. For more information about the selection language, please refer to [the section of Atom and Virtual Atoms in the documentation](https://www.plumed.org/doc-master/user-doc/html/_group.html).
    - The keyword `DISTANCE` calculates the distance between a pair of atoms. For more information about collective variables available in PLUMED, please refer [CV documentation](https://www.plumed.org/doc-master/user-doc/html/_colvar.html).
    - The keyword `PRINT` prints quantities to the file specified by `FILE` with a frequency specified by `STRIDE` (units: step).

- To analyze the trajectory `complex_decouple.xtc`, execute the following command:
   ```
   plumed driver --plumed plumed_dist.dat --mf_xtc traj_comp.xtc --pdb complex.pdb 
   ```
   After the command above is exectued, an output file `dist.dat` will be generated.


## 2. Metadynamics
After PLUMED is patched with GROMACS, one can run metadynamics by simply using `-plumed` flag when executing `gmx mdrun`, as illustrated below. In folder `MetaD`, there are the following files:
- GROMACS simulation files, including an input structure `complex.gro`, a topology file `complex.top`, a GROMACS parameter file `complex.mdp` and a `.tpr` file generated by `gmx grompp` taking the other three files as the input. 
- `plumed.dat`: A PLUMED parameter file that defines the collective variables to bias in the metadynamics and specifies the relevant parameters. In this example, we calculate the coordination number of water molecules for `center`, which is a virtual atom serving as the center of a sphere that best approximates the binding cavity. This collective variable estimates the number of water molecules in the binding cavity. Specifically, the content of `plumed.dat` is as follows:
    ```
    center1: CENTER ATOMS=1-40                        # geometric center of the smaller ring
    center2: CENTER ATOMS=57-112,116-121,123-128      # geometric center of the bigger ring
    center: CENTER ATOMS=center1,center2 WEIGHTS=2,3  # center of the sphere

    water_group: GROUP ATOMS=217-7974:3         # oxygen atom of the water molecules

    n: COORDINATION GROUPA=center GROUPB=water_group R_0=0.5 NN=1 MM=25   # unit of length: nm

    METAD ...
    ARG=n
    SIGMA=0.02
    HEIGHT=0.3
    PACE=500
    BIASFACTOR=10
    TEMP=298
    LABEL=metad
    GRID_MIN=0.0
    GRID_MAX=6.0
    GRID_BIN=600
    FILE=HILLS_COORDN
    ... METAD

    PRINT STRIDE=10 ARG=n,metad.bias FILE=COLVAR
    ```
    - The keyword `COORDINATION` calculates the number of contacts between two groups of atoms specified by `GROUPA` and `GROUPB`, with a switching function defined by parameters including `R_0`, `NN`, and `MM`.
    - The keyword `METAD` enables metadynamics which biases the collective variable(s) specified by `ARG`. The height and width of the biasing Gaussian potential, and the frequency of adding it can be specified by `HEIGHT`, `SIGMA`, and `PACE`. 
    - The keywords `BIASFACTOR` and `TEMP` are specifically for well-tempered metadynamics. Specifically, a bias factor in well-tempered metadynamics is defined as the ratio of T+ΔT and T, where, T is the system temperature that can be specified by `TEMP` and ΔT is a parameter used to tune the magnitude of the bias factor. 
    - `LABEL` gives a variable name (`metad`) for `METAD` such that we can print the biasing potential (`meta.bias`) to the output file `COLVAR`. (As a result, in the output file `COLVAR`, there will be two columns that correspond to `n` and `meta.bias`, respectively.) The keyword `FILE` in the section `METAD` specifies the file name of the file in which the list of added hills is stored.
    - In metadynamics performed by PLUMED, the bias potential is stored on a grid, whose boundaries are specified by the keywords `GRID_MIN` and `GRID_MAX`. With the keywords `GRID_BIN` or `GRID_SPACING`, one can specify how dense the bins should be.

## 3. Multiple walkers metadynamics in multi-dimensional space
In addition to 1D well-tempered metadynamics, PLUMED also allows multiple walkers metadynamics or multi-dimensional metadynamics. Currently, multiple walkers metadynamics can be implemented by making use of MPI or external files containing all the positions of Gaussians. The command to run a multiple walkers metadynamics is the same as the one used in standard metadynamics (simply adding `-plumed` flag). In folder `Multi_Walkers`, there are two PLUMED parameter files (`plumed_file.dat` and `plumed_mpi.dat`), which are introduced in the sections below.

### 3-1. File-based multiple walkers metadynamics
As an example, the content of `plumed_file.dat` is as follows:
```
# 2D well-tempered multiple walkers metadynamics
# CV1: projection of the COM axis to the host axis
# CV2: the angle between the COM axis and the host axis
# Note that this is a file-version of multiple walker metadynamics

# First, the COM axis is the line connecting c1 and c2
c1: COM ATOMS=1-184                          # COM of the host
c2: COM ATOMS=185-201                        # COM of the ligand

# Then define the host axis, which connects p1 and p2
p1: COM ATOMS=57-122,116-121,123-128         # endpoint of defining the host axis (outer)
p2: COM ATOMS=1-40                           # endpoint of defining the host axis (inner)    

# Define CV1 (d)  and CV2 (a)
a: ANGLE ATOMS=c1,c2,p1,p2                   # angle between the COM axis and the host axis
d12: DISTANCE ATOMS=c1,c2                    # distance between c1 and c2 (COM separation)
d: MATHEVAL ARG=d12,a VAR=x,y FUNC=x*abs(cos(y)) PERIODIC=NO
# projection of line c1c2 to the host axis (x=d12, y=a)

METAD ...
   ARG=d,a
   SIGMA=0.05,0.05
   HEIGHT=0.3
   PACE=500
   BIASFACTOR=10
   TEMP=298.15
   LABEL=metad
   GRID_MIN=0,0
   GRID_MAX=2.0,3.14
   GRID_BIN=400,314
   FILE=HILLS_proj_angle
   WALKERS_N=4
   WALKERS_ID=0
   WALKERS_DIR=./HILLS
   WALKERS_RSTRIDE=100
... METAD

PRINT STRIDE=10 ARG=d,a,metad.bias FILE=COLVAR
```
- Note that in this example, metadynamics is biasing two different collective variables (`d` and `a`, hence a 2D metadynamics), whose width of the Gaussian potential and the boundaries of the grid can be specified differently. 

- The syntax of a file-based multiple walkers metadynamics is exactly the same as the standard metadynamics shown in Section 2, except that we have to specify parameters including:
  - `WALKERS_N`: the number of walkers
  - `WALKERS_ID`: the walker ID
  - `WALKERS_DIR`: the directory where all the `HILLS` files from different walkers will be saved.
  - `WALKERS_RSTRIDE`: stride for reading `HILLS` files.
- Note that it requires multiple PLUMED parameter files (for example, `plumed.0.dat`, `plumed.1.dat`, `plumed.2.dat`, and `plumed.3.dat` for 4 walkers) to run the file-based multiple walkers metadynamics. (`-plumed` flag should be able to read all of them at the same time.) As a result, one `COLVAR` output file will be saved in the working directory and multiple `HILLS` files will be saved in the directory specified by `WALKERS_DIR`, one for each walker. The only difference between different PLUMED parameter files is the walker ID. Specifically, `WALKERS_ID=X` is specified in `plumed.X.dat`.

### 3-2. MPI-based multiple walkers metadynamics
The PLUMED input file for an MPI-based multiple walkers metadynamics is basically the same as the one used in the file version except that there are no "walker-specific" keywords, including `WALKERS_N`, `WALKERS_ID`, and `WALKERS_RSTRIDE` and the user have to add `WALKERS_MPI` in the section `METAD`. (Note that `WALKERS_DIR` can work with `WALKERS_MPI` in the MPI-based multiple walkers metadynamics). Also, in contrast to file-based multiple walkers metadynamics, the MPI version only requires one `plumed.dat` and there will be only one `HILLS` and `COLVAR` file generated. 